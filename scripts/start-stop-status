#!/bin/bash

# Radicale for Synology DSM
#
# Copyright (C) 2017 Thomas Himmelstoss
#
# This software may be freely distributed under the MIT license. You should
# have received a copy of the MIT License along with this program.

PID_FILE="/tmp/radicale.pid"

log() {
    echo "[INFO] $1"
}

start_radicale() {
    log "Starting Radicale"
    log "SYNOPKG_PKGDEST=${SYNOPKG_PKGDEST}"

    local python="${SYNOPKG_PKGDEST}/radicale-env/bin/python3"
    local pymodules="${SYNOPKG_PKGDEST}/lib"
    local configfile="${SYNOPKG_PKGDEST}/radicale.conf"

    log "python=${python}"
    log "pymodules=${pymodules}"
    log "configfile=${configfile}"

    PYTHONPATH="${pymodules}" "${python}" -m radicale --config "${configfile}"
}

stop_radicale() {
    log "Stopping Radicale"

    log "PID_FILE=${PID_FILE}"

    local pid="$(cat ${PID_FILE})"

    log "pid=${pid}"

    /bin/kill -TERM "${pid}"
}

case $1 in
        start)
               start_radicale
	       exit 0
        ;;
        stop)
               stop_radicale
	       exit 0
	;;
        status)
	       exit 0
	;;
esac

